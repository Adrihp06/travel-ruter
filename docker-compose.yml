services:
  # ===========================================
  # PostgreSQL + PostGIS Database
  # ===========================================
  db:
    image: kartoza/postgis:18-3.6
    container_name: travel_ruter_db
    restart: unless-stopped
    environment:
      # Kartoza usa variables ligeramente distintas
      POSTGRES_DB: ${POSTGRES_DB:-travel_ruter}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      # Kartoza usa POSTGRES_PASS en lugar de POSTGRES_PASSWORD
      POSTGRES_PASS: ${POSTGRES_PASSWORD:-postgres}
      # IMPORTANTE: Permite conexiones desde el backend (red docker)
      ALLOW_IP_RANGE: "0.0.0.0/0"
      # Forzar codificación correcta
      DbHost: "db"
      # PostgreSQL tuning
      EXTRA_CONF: |-
        shared_buffers = 128MB
        work_mem = 8MB
        effective_cache_size = 384MB
        max_connections = 50
    shm_size: '256m'
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql
    networks:
      - travel-ruter-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-travel_ruter}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  # ===========================================
  # FastAPI Backend
  # ===========================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: adrihp06/travel-ruter-backend:latest
    container_name: travel_ruter_backend
    restart: unless-stopped
    volumes:
      # Document storage (The Vault) - persistent storage for uploaded files
      - vault_data:/app/documents
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    environment:
      # Database credentials (for entrypoint health check)
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-travel_ruter}
      # Database
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-travel_ruter}
      # Application
      APP_ENV: ${APP_ENV:-production}
      DEBUG: ${DEBUG:-false}
      SECRET_KEY: ${SECRET_KEY:?SECRET_KEY must be set in .env}
      API_HOST: 0.0.0.0
      API_PORT: 8000
      # Documents / Vault
      DOCUMENTS_UPLOAD_PATH: /app/documents
      MAX_UPLOAD_SIZE_MB: ${MAX_UPLOAD_SIZE_MB:-50}
      # JWT Authentication
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      JWT_EXPIRATION_MINUTES: ${JWT_EXPIRATION_MINUTES:-30}
      # OAuth providers
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:-}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost}
      PUBLIC_URL: ${PUBLIC_URL:-http://localhost}
      # Encryption (per-trip API keys)
      FERNET_KEY: ${FERNET_KEY:-}
      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:5173,http://localhost:80}
      # External APIs
      MAPBOX_ACCESS_TOKEN: ${MAPBOX_ACCESS_TOKEN:-}
      OPENROUTESERVICE_API_KEY: ${OPENROUTESERVICE_API_KEY:-}
      GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY:-}
      # Amadeus API (Hotels)
      AMADEUS_CLIENT_ID: ${AMADEUS_CLIENT_ID:-}
      AMADEUS_CLIENT_SECRET: ${AMADEUS_CLIENT_SECRET:-}
      # Cloudflare Access (Zero Trust)
      CF_ACCESS_ENABLED: ${CF_ACCESS_ENABLED:-false}
      CF_ACCESS_DOMAIN: ${CF_ACCESS_DOMAIN:-}
      CF_ACCESS_AUD: ${CF_ACCESS_AUD:-}
      # Internal service auth (orchestrator → backend)
      INTERNAL_SERVICE_KEY: ${INTERNAL_SERVICE_KEY:-}
    networks:
      - travel-ruter-network
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M

  # ===========================================
  # AI Orchestrator (Python/PydanticAI)
  # ===========================================
  orchestrator:
    build:
      context: .
      dockerfile: ./orchestrator/Dockerfile
    image: adrihp06/travel-ruter-orchestrator:latest
    container_name: travel_ruter_orchestrator
    restart: unless-stopped
    ports:
      - "${ORCHESTRATOR_PORT:-3001}:3001"
    environment:
      PORT: 3001
      # MCP Server configuration
      PYTHONPATH: /app
      # Database (for MCP server)
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-travel_ruter}
      # Provider API keys (optional - reads from mounted credentials)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT:-}
      GOOGLE_CLOUD_LOCATION: ${GOOGLE_CLOUD_LOCATION:-us-central1}
      OLLAMA_HOST: ${OLLAMA_HOST:-http://host.docker.internal:11434}
      # JWT (must match backend SECRET_KEY so orchestrator can verify JWTs)
      JWT_SECRET_KEY: ${SECRET_KEY:?SECRET_KEY must be set in .env}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      # Travel API keys (forwarded to MCP server subprocess)
      GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY:-}
      OPENROUTESERVICE_API_KEY: ${OPENROUTESERVICE_API_KEY:-}
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-}
      # Internal service auth (orchestrator → backend)
      INTERNAL_SERVICE_KEY: ${INTERNAL_SERVICE_KEY:-}
      # CORS (restrict in production)
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:5173,http://localhost:80}
    networks:
      - travel-ruter-network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M

  # ===========================================
  # React Frontend (Nginx)
  # ===========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-/api}
        VITE_ORCHESTRATOR_URL: ${VITE_ORCHESTRATOR_URL:-/chat}
        VITE_AUTH_ENABLED: ${VITE_AUTH_ENABLED:-false}
        VITE_CF_ACCESS_ENABLED: ${VITE_CF_ACCESS_ENABLED:-false}
    image: adrihp06/travel-ruter-frontend:latest
    container_name: travel_ruter_frontend
    restart: unless-stopped
    environment:
      VITE_MAPBOX_ACCESS_TOKEN: ${VITE_MAPBOX_ACCESS_TOKEN:-}
    ports:
      - "${FRONTEND_PORT:-80}:80"
    networks:
      - travel-ruter-network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:80/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 64M

  # ===========================================
  # Cloudflare Tunnel (Production only)
  # ===========================================
  # Activated with: docker compose --profile prod up
  # Configure the tunnel to point to http://frontend:80 in the Cloudflare dashboard.
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: travel_ruter_tunnel
    restart: unless-stopped
    command: tunnel run
    environment:
      TUNNEL_TOKEN: ${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - travel-ruter-network
    depends_on:
      frontend:
        condition: service_healthy
    profiles:
      - prod
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
        reservations:
          cpus: "0.05"
          memory: 32M

# ===========================================
# Volumes
# ===========================================
volumes:
  # PostgreSQL data persistence
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${POSTGRES_DATA_PATH:-./data/postgres}

  # Document storage (The Vault)
  vault_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${VAULT_DATA_PATH:-./data/vault}

# ===========================================
# Networks
# ===========================================
networks:
  travel-ruter-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
