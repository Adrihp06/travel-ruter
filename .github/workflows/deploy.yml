name: Build & Deploy to NAS

on:
  push:
    branches: [main]
  workflow_dispatch: # manual trigger

env:
  DOCKER_HUB_USER: adrihp06
  BACKEND_IMAGE: adrihp06/travel-ruter-backend
  FRONTEND_IMAGE: adrihp06/travel-ruter-frontend
  ORCHESTRATOR_IMAGE: adrihp06/travel-ruter-orchestrator
  DEPLOY_DIR: /volume1/00_Docker/travelruter

# Only allow one deployment at a time; cancel in-progress runs on new pushes
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push backend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:latest
            ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          build-args: |
            VITE_API_URL=/api
            VITE_ORCHESTRATOR_URL=/chat
            VITE_AUTH_ENABLED=true
            VITE_MAPBOX_ACCESS_TOKEN=${{ secrets.VITE_MAPBOX_ACCESS_TOKEN }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push orchestrator
        uses: docker/build-push-action@v6
        with:
          context: ./orchestrator
          file: ./orchestrator/Dockerfile
          push: true
          tags: |
            ${{ env.ORCHESTRATOR_IMAGE }}:latest
            ${{ env.ORCHESTRATOR_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: self-hosted # NAS runner — see setup notes below
    steps:
      - uses: actions/checkout@v4

      - name: Sync compose file to deploy directory
        run: |
          mkdir -p ${{ env.DEPLOY_DIR }}
          cp docker-compose.yml ${{ env.DEPLOY_DIR }}/docker-compose.yml

      - name: Deploy with Docker Compose
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          docker compose --profile prod pull
          docker compose --profile prod up -d --remove-orphans
          docker compose --profile prod ps

# =============================================================================
# Self-hosted runner setup (NAS)
# =============================================================================
# 1. Go to GitHub repo → Settings → Actions → Runners → New self-hosted runner
# 2. Follow the instructions for Linux (or Linux/ARM if your NAS uses ARM)
# 3. Install the runner as a service:
#      sudo ./svc.sh install && sudo ./svc.sh start
# 4. Ensure Docker and Docker Compose are available on the NAS
# 5. Place your .env file at /volume1/00_Docker/travelruter/.env
#
# Required GitHub Secrets:
#   DOCKERHUB_USERNAME       — Docker Hub username (adrihp06)
#   DOCKERHUB_TOKEN          — Docker Hub access token (not password)
#   VITE_MAPBOX_ACCESS_TOKEN — Mapbox token baked into frontend build
